<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Firebase v10.12.0 compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 40px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f2f2f2; }
    button { padding: 5px 10px; margin: 2px; }
    .loading { margin: 20px 0; font-size: 1.1em; color: #666; }
    @media (max-width: 600px) {
      table, th, td { font-size: 12px; }
    }
  </style>
</head>
<body>

  <h1>Admin Dashboard</h1>

  <div id="content">

    <!-- Deposit Requests Section -->
    <h2>Deposit Requests</h2>
    <div id="depositLoading" class="loading">Loading deposits...</div>
    <div class="table-container">
      <table id="depositTable" style="display:none;">
        <thead>
          <tr>
            <th>Request ID</th><th>User ID</th><th>Amount</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="depositBody"></tbody>
      </table>
    </div>

    <!-- Buy Orders Section -->
    <h2>Buy Orders</h2>
    <div id="ordersLoading" class="loading">Loading orders...</div>
    <div class="table-container">
      <table id="ordersTable" style="display:none;">
        <thead>
          <tr>
            <th>Order ID</th><th>User ID</th><th>Total Price</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>

    <!-- Seller Applications Section -->
    <h2>Seller Applications</h2>
    <div id="sellerLoading" class="loading">Loading applications...</div>
    <div class="table-container">
      <table id="sellerTable" style="display:none;">
        <thead>
          <tr>
            <th>Application ID</th><th>User ID</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="sellerBody"></tbody>
      </table>
    </div>

  </div>

  <script>
    // Firebase configuration (replace with your config)
    const firebaseConfig = {
      apiKey: "...",
      authDomain: "...",
      projectId: "...",
      // ... other config ...
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const adminUID = 'gRdZaqJC3GRKdoeOTqZ6L3w3NGw2';

    // Auth state listener to verify admin
    firebase.auth().onAuthStateChanged((user) => {
      if (!user || user.uid !== adminUID) {
        window.location.href = 'index.html';
      } else {
        // User is admin; load data
        loadDepositRequests();
        loadBuyOrders();
        loadSellerApplications();
      }
    });

    // Load Deposit Requests
    function loadDepositRequests() {
      const depositTable = document.getElementById('depositTable');
      const depositBody = document.getElementById('depositBody');
      depositBody.innerHTML = '';
      // Example: filter for pending deposits
      db.collection('Depositrequest').where('status', '==', 'pending').get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const data = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${doc.id}</td>
              <td>${data.userId}</td>
              <td>${data.amount}</td>
              <td>${data.status}</td>
              <td>
                <button onclick="approveDeposit('${doc.id}', '${data.userId}', ${data.amount})">Approve</button>
                <button onclick="rejectDeposit('${doc.id}')">Reject</button>
              </td>`;
            depositBody.appendChild(tr);
          });
          document.getElementById('depositLoading').style.display = 'none';
          depositTable.style.display = snapshot.empty ? 'none' : 'table';
        });
    }

    function approveDeposit(docId, userId, amount) {
      const depositRef = db.collection('Depositrequest').doc(docId);
      const buyerRef = db.collection('Buyers').doc(userId);
      // Update buyer balance
      buyerRef.update({ balance: firebase.firestore.FieldValue.increment(amount) })
        .then(() => {
          // Mark deposit as approved
          return depositRef.update({ status: 'approved' });
        })
        .then(() => {
          loadDepositRequests();
        })
        .catch(error => {
          alert('Error approving deposit: ' + error.message);
        });
    }

    function rejectDeposit(docId) {
      db.collection('Depositrequest').doc(docId)
        .update({ status: 'rejected' })
        .then(() => {
          loadDepositRequests();
        });
    }

    // Load Buy Orders
    function loadBuyOrders() {
      const ordersTable = document.getElementById('ordersTable');
      const ordersBody = document.getElementById('ordersBody');
      ordersBody.innerHTML = '';
      // Filter for relevant statuses
      db.collection('Buyorder')
        .where('status', 'in', ['pending','approved','rejected'])
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const data = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${doc.id}</td>
              <td>${data.userId}</td>
              <td>${data.totalPrice}</td>
              <td>${data.status}</td>
              <td>
                <button onclick="approveOrder('${doc.id}', '${data.userId}', ${data.totalPrice})">Approve</button>
                <button onclick="rejectOrder('${doc.id}', '${data.userId}', ${data.totalPrice})">Reject</button>
              </td>`;
            ordersBody.appendChild(tr);
          });
          document.getElementById('ordersLoading').style.display = 'none';
          ordersTable.style.display = snapshot.empty ? 'none' : 'table';
        });
    }

    function approveOrder(docId, userId, totalPrice) {
      const buyerRef = db.collection('Buyers').doc(userId);
      const orderRef = db.collection('Buyorder').doc(docId);
      buyerRef.get().then(buyDoc => {
        const balance = buyDoc.data().balance || 0;
        if (balance < totalPrice) {
          alert('Insufficient funds for this buyer.');
          return;
        }
        // Deduct from buyer
        buyerRef.update({ balance: firebase.firestore.FieldValue.increment(-totalPrice) })
          .then(() => {
            // Approve order
            return orderRef.update({ status: 'approved' });
          })
          .then(() => {
            loadBuyOrders();
          });
      });
    }

    function rejectOrder(docId, userId, totalPrice) {
      const orderRef = db.collection('Buyorder').doc(docId);
      orderRef.get().then(orderDoc => {
        const prevStatus = orderDoc.data().status;
        const batch = db.batch();
        if (prevStatus === 'approved') {
          // Refund buyer
          const buyerRef = db.collection('Buyers').doc(userId);
          batch.update(buyerRef, { balance: firebase.firestore.FieldValue.increment(totalPrice) });
        }
        // Update order status to rejected
        batch.update(orderRef, { status: 'rejected' });
        return batch.commit();
      }).then(() => {
        loadBuyOrders();
      });
    }

    // Load Seller Applications
    function loadSellerApplications() {
      const sellerTable = document.getElementById('sellerTable');
      const sellerBody = document.getElementById('sellerBody');
      sellerBody.innerHTML = '';
      // Example: filter pending applications
      db.collection('sellerApplications').where('status', '==', 'pending').get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const data = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${doc.id}</td>
              <td>${data.userId}</td>
              <td>${data.status}</td>
              <td>
                <button onclick="approveSeller('${doc.id}', '${data.userId}')">Approve</button>
                <button onclick="rejectSeller('${doc.id}', '${data.userId}')">Reject</button>
              </td>`;
            sellerBody.appendChild(tr);
          });
          document.getElementById('sellerLoading').style.display = 'none';
          sellerTable.style.display = snapshot.empty ? 'none' : 'table';
        });
    }

    function approveSeller(appId, userId) {
      const appRef = db.collection('sellerApplications').doc(appId);
      const buyerRef = db.collection('Buyers').doc(userId);
      // Set isSeller = true
      buyerRef.update({ isSeller: true })
        .then(() => {
          return appRef.update({ status: 'approved' });
        })
        .then(() => {
          loadsellerApplications();
        });
    }

    function rejectSeller(appId, userId) {
      const appRef = db.collection('sellerApplications').doc(appId);
      const buyerRef = db.collection('Buyers').doc(userId);
      // Remove isSeller field using FieldValue.delete()
      buyerRef.update({ isSeller: firebase.firestore.FieldValue.delete() })
        .then(() => {
          return appRef.update({ status: 'rejected' });
        })
        .then(() => {
          loadsellerApplications();
        });
    }
  </script>

</body>
</html>